name: Execute Playwright
on:
  workflow_call:
    inputs:
      git_ref:
        type: string
        required: true
      update_screenshots:
        type: boolean
        default: false

jobs:
  exec-playwright:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.10"
      POETRY_VERSION: "2.0.1"
      TEST_RESULT_DIR: test-results
      TEST_REPORT_DIR: playwright-report
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.git_ref }}
    - name: Install poetry
      run: pipx install poetry==${{ env.POETRY_VERSION }}
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "poetry"
    - name: Install tools
      run: sudo apt-get install -y gettext
    - run: poetry install

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - run: yarn install
    - name: Install dependencies
      run: yarn pretest:install-playwright

    - name: Load master screenshots from cache
      uses: actions/cache@v4
      with:
        path: ${{ env.TEST_RESULT_DIR }}
        key: playwright-result-${{ github.sha }}

    - if: ${{ inputs.update_screenshots }}
      name: Run playwright tests
      run: yarn test:vrt --update-snapshots

    - if: ${{ !inputs.update_screenshots }}
      name: Run playwright tests
      run: yarn test:vrt
    - if: ${{ !inputs.update_screenshots }}
      name: Cache playwright report
      uses: actions/cache/save@v4
      with:
        path: playwright-report
        key: playwright-report-${{ github.sha }}
